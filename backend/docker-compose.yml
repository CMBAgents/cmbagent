# CMBAgent Backend Docker Compose
#
# Usage:
#   docker compose up -d        # Start in background
#   docker compose logs -f      # View logs
#   docker compose down         # Stop
#
# Required setup:
#   1. Create credentials/ directory with firebase-credentials.json
#   2. Set API keys in .env file (see .env.example)

services:
  cmbagent-backend:
    build:
      context: ..
      dockerfile: backend/Dockerfile
    container_name: cmbagent-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Mount credentials (Firebase service account JSON)
      - ./credentials:/app/credentials:ro
      # Mount RAID storage for task outputs (28TB)
      - /rds/rds-ai-scientist/users-data:/app/workdir
    environment:
      # Number of uvicorn workers (Threadripper PRO 9995WX can handle many more)
      - UVICORN_WORKERS=32
      # Work directory inside container
      - CMBAGENT_WORK_DIR=/app/workdir
      # Local dev mode
      - CMBAGENT_LOCAL_DEV=${CMBAGENT_LOCAL_DEV:-false}
      # Firebase credentials path (inside container)
      - FIREBASE_CREDENTIALS=/app/credentials/firebase-credentials.json
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/firebase-credentials.json
      # API keys (loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - OPEN_ROUTER_KEY=${OPEN_ROUTER_KEY}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
      - FUTURE_HOUSE_API_KEY=${FUTURE_HOUSE_API_KEY:-}
      # Optional: Vertex AI project
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Resource limits (Threadripper PRO 9995WX / 28TB RAID)
    deploy:
      resources:
        limits:
          memory: 32G
        reservations:
          memory: 8G

# Optional: Add a reverse proxy for HTTPS
#  nginx:
#    image: nginx:alpine
#    ports:
#      - "443:443"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./certs:/etc/nginx/certs:ro
#    depends_on:
#      - cmbagent-backend
